from flask import Flask, render_template, request, jsonify
import re
import os

app = Flask(__name__)

# Cache the log content in memory when the server starts
log_cache = []
summary_cache = ""

LOG_FILE = 'vulnerability_scanner.log'
SUMMARY_FILE = 'vulnerability_summary.txt'

def load_log_file():
    global log_cache
    with open("vulnerability_scanner.log", "r") as f:
        log_cache = f.readlines()

def load_summary_file():
    global summary_cache
    with open("vulnerability_summary.txt", "r") as f:
        summary_cache = f.read()

# Load log file and summary file on startup
load_log_file()
load_summary_file()

# Pre-filtered search results to avoid reprocessing each time
clickjacking_results = []
sql_results = []
xss_results = []
bac_results = []
cmd_injection_results = []

# Utility function to filter log based on keyword
def filter_log(keyword):
    results = [line for line in log_cache if keyword in line]
    return results if results else ["No results found."]

# Populate pre-filtered results on startup
clickjacking_results = filter_log("Clickjacking")
sql_results = filter_log("SQL")
xss_results = filter_log("XSS")
bac_results = filter_log("Broken Access Control")
cmd_injection_results = filter_log("Command Injection")

@app.route("/")
def index():
    return render_template("index.html", summary=summary_cache)

@app.route("/search", methods=["POST"])
def search():
    search_type = request.json.get("type")
    
    if search_type == "clickjacking":
        results = clickjacking_results
    elif search_type == "sql":
        results = sql_results
    elif search_type == "xss":
        results = xss_results
    elif search_type == "bac":
        results = bac_results
    elif search_type == "cmd_injection":
        results = cmd_injection_results
    else:
        results = ["Invalid search type."]
    
    # Remove empty lines and format with newlines
    formatted_results = "\n".join([line.strip() for line in results if line.strip()])
    
    return jsonify({"results": formatted_results})

@app.route("/get-log")
def get_log():
    """Serve the latest log file content."""
    if os.path.exists(LOG_FILE):
        with open(LOG_FILE, 'r') as f:
            log_content = f.read()
    else:
        log_content = "Log file not found."

    return jsonify({"log": log_content})

@app.route("/get-summary")
def get_summary():
    """Serve the summary log content."""
    if os.path.exists(SUMMARY_FILE):
        with open(SUMMARY_FILE, 'r') as f:
            summary_content = f.read()
    else:
        summary_content = "Summary file not found."

    return jsonify({"summary": summary_content})

if __name__ == "__main__":
    app.run(debug=True)

if __name__ == "__main__":
    app.run(debug=True)
