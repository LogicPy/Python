import os
import sys
import requests
import logging
import argparse
from dotenv import load_dotenv
from tabulate import tabulate
from datetime import datetime

# Load environment variables from .env
load_dotenv()

# Configure logging
logging.basicConfig(
    level=logging.INFO,  # Set to DEBUG for more verbose output
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.StreamHandler(sys.stdout)
    ]
)

# Constants
NVD_API_URL = 'https://services.nvd.nist.gov/rest/json/cves/1.0/'
NVD_API_KEY = os.getenv('NVD_API_KEY')

if not NVD_API_KEY:
    logging.error("NVD_API_KEY not found. Please set it in your .env file.")
    sys.exit(1)

def search_cves(keyword=None, cve_id=None, pub_start_date=None, pub_end_date=None, results_per_page=20):
    """
    Search CVEs based on provided criteria.

    :param keyword: Keyword to search in CVE descriptions.
    :param cve_id: Specific CVE ID to retrieve.
    :param pub_start_date: Publication start date in YYYY-MM-DD format.
    :param pub_end_date: Publication end date in YYYY-MM-DD format.
    :param results_per_page: Number of results per page (max 2000).
    :return: List of CVE items.
    """
    headers = {
        'apiKey': NVD_API_KEY
    }
    params = {
        'resultsPerPage': results_per_page
    }

    if keyword:
        params['keyword'] = keyword
    if cve_id:
        params['cveId'] = cve_id
    if pub_start_date:
        # Convert to RFC3339 format
        try:
            datetime_obj = datetime.strptime(pub_start_date, '%Y-%m-%d')
            params['pubStartDate'] = datetime_obj.isoformat() + "Z"
        except ValueError:
            logging.error("Invalid pub_start_date format. Use YYYY-MM-DD.")
            return []
    if pub_end_date:
        try:
            datetime_obj = datetime.strptime(pub_end_date, '%Y-%m-%d')
            params['pubEndDate'] = datetime_obj.isoformat() + "Z"
        except ValueError:
            logging.error("Invalid pub_end_date format. Use YYYY-MM-DD.")
            return []

    try:
        response = requests.get(NVD_API_URL, headers=headers, params=params, timeout=30)
        logging.info(f"Request URL: {response.url}")
        response.raise_for_status()
        data = response.json()
        cve_items = data.get('result', {}).get('CVE_Items', [])
        return cve_items
    except requests.exceptions.HTTPError as http_err:
        logging.error(f"HTTP error occurred: {http_err} - {response.text}")
    except requests.exceptions.RequestException as req_err:
        logging.error(f"Request exception: {req_err}")
    except ValueError as json_err:
        logging.error(f"JSON decode error: {json_err} - Response Content: {response.text}")
    except Exception as e:
        logging.error(f"An unexpected error occurred: {e}")

    return []

def extract_cve_details(cve_item):
    """
    Extract detailed information from a CVE item.

    :param cve_item: A single CVE item from the NVD API response.
    :return: Dictionary containing extracted CVE details.
    """
    try:
        cve_id = cve_item['cve']['CVE_data_meta']['ID']
        description_data = cve_item['cve']['description']['description_data']
        description = description_data[0]['value'] if description_data else 'No description available.'

        # CVSS Scores
        impact = cve_item.get('impact', {})
        if 'baseMetricV3' in impact:
            cvss_v3 = impact['baseMetricV3']['cvssV3']
            severity = cvss_v3.get('baseSeverity', 'N/A')
            cvss_score = cvss_v3.get('baseScore', 'N/A')
        elif 'baseMetricV2' in impact:
            cvss_v2 = impact['baseMetricV2']['cvssV2']
            severity = impact['baseMetricV2'].get('severity', 'N/A')
            cvss_score = cvss_v2.get('baseScore', 'N/A')
        else:
            severity = 'N/A'
            cvss_score = 'N/A'

        # References
        references = []
        for ref in cve_item['cve']['references']['reference_data']:
            ref_url = ref.get('url', 'N/A')
            ref_name = ref.get('name', 'N/A')
            ref_tags = ', '.join(ref.get('tags', []))
            references.append({'URL': ref_url, 'Name': ref_name, 'Tags': ref_tags})

        # Published and Last Modified Dates
        published_date = cve_item.get('publishedDate', 'N/A')
        last_modified_date = cve_item.get('lastModifiedDate', 'N/A')

        # Vulnerable Configurations
        configurations = cve_item.get('configurations', {}).get('nodes', [])
        vulnerable_products = []
        for node in configurations:
            cpe_matches = node.get('cpe_match', [])
            for cpe in cpe_matches:
                vulnerable_products.append(cpe.get('cpe23Uri', 'N/A'))

        return {
            'CVE ID': cve_id,
            'Description': description,
            'Severity': severity,
            'CVSS Score': cvss_score,
            'Published Date': published_date,
            'Last Modified Date': last_modified_date,
            'Vulnerable Products': vulnerable_products,
            'References': references
        }
    except Exception as e:
        logging.error(f"Error extracting CVE details: {e}")
        return {}

def display_cves(cve_details_list):
    """
    Display CVE details in a tabular format.

    :param cve_details_list: List of dictionaries containing CVE details.
    """
    table_data = []
    for cve in cve_details_list:
        table_data.append([
            cve.get('CVE ID', 'N/A'),
            cve.get('Description', 'N/A'),
            cve.get('Severity', 'N/A'),
            cve.get('CVSS Score', 'N/A'),
            cve.get('Published Date', 'N/A'),
            cve.get('Last Modified Date', 'N/A')
        ])
    
    headers = ['CVE ID', 'Description', 'Severity', 'CVSS Score', 'Published Date', 'Last Modified Date']
    print(tabulate(table_data, headers=headers, tablefmt='grid'))

def export_cves(cve_details_list, export_format='csv', filename='cve_results'):
    """
    Export CVE details to a file.

    :param cve_details_list: List of dictionaries containing CVE details.
    :param export_format: Format to export ('csv' or 'json').
    :param filename: Base filename without extension.
    """
    if export_format == 'csv':
        import csv

        csv_file = f"{filename}.csv"
        try:
            with open(csv_file, mode='w', newline='', encoding='utf-8') as file:
                writer = csv.writer(file)
                writer.writerow(['CVE ID', 'Description', 'Severity', 'CVSS Score', 'Published Date', 'Last Modified Date'])
                for cve in cve_details_list:
                    writer.writerow([
                        cve.get('CVE ID', 'N/A'),
                        cve.get('Description', 'N/A'),
                        cve.get('Severity', 'N/A'),
                        cve.get('CVSS Score', 'N/A'),
                        cve.get('Published Date', 'N/A'),
                        cve.get('Last Modified Date', 'N/A')
                    ])
            logging.info(f"CVE details exported to {csv_file}")
        except Exception as e:
            logging.error(f"Error exporting to CSV: {e}")

    elif export_format == 'json':
        import json

        json_file = f"{filename}.json"
        try:
            with open(json_file, mode='w', encoding='utf-8') as file:
                json.dump(cve_details_list, file, indent=4)
            logging.info(f"CVE details exported to {json_file}")
        except Exception as e:
            logging.error(f"Error exporting to JSON: {e}")
    else:
        logging.error("Unsupported export format. Choose 'csv' or 'json'.")

def main():
    print ("python nvd_exploit_search_engine.py -k 'Exim smtpd 4.97.1'\npython nvd_exploit_search_engine.py -c CVE-2021-XXXX")

    parser = argparse.ArgumentParser(description="NVD Exploit Search Engine")
    group = parser.add_mutually_exclusive_group(required=True)
    group.add_argument('-k', '--keyword', type=str, help='Keyword to search in CVE descriptions.')
    group.add_argument('-c', '--cve', type=str, help='Specific CVE ID to retrieve.')
    parser.add_argument('--pub_start', type=str, help='Publication start date (YYYY-MM-DD).')
    parser.add_argument('--pub_end', type=str, help='Publication end date (YYYY-MM-DD).')
    parser.add_argument('--export', type=str, choices=['csv', 'json'], help='Export results to file.')
    parser.add_argument('--filename', type=str, default='cve_results', help='Filename for exported results.')
    args = parser.parse_args()

    cve_items = search_cves(
        keyword=args.keyword,
        cve_id=args.cve,
        pub_start_date=args.pub_start,
        pub_end_date=args.pub_end
    )

    if not cve_items:
        logging.info("No CVEs found based on the provided criteria.")
        return

    cve_details_list = []
    for item in cve_items:
        details = extract_cve_details(item)
        if details:
            cve_details_list.append(details)

    if cve_details_list:
        display_cves(cve_details_list)
        if args.export:
            export_cves(cve_details_list, export_format=args.export, filename=args.filename)
    else:
        logging.info("No detailed CVE information available.")

if __name__ == "__main__":
    main()
